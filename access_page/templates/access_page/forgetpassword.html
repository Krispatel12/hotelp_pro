{% extends 'core/base.html' %}
{% load static %}

{% block title %}Forget Password - HotelPro{% endblock %}

{% block content %}
<div
    class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800">
    <div class="max-w-md w-full space-y-8 glass-card p-10 rounded-3xl relative overflow-hidden fade-in-up">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-purple-500"></div>

        <div class="text-center">
            <h2 class="mt-6 text-3xl font-extrabold text-gray-900 dark:text-white">
                Forget Password
            </h2>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Or <a href="{% url 'login' %}"
                    class="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400">sign in to your
                    existing account</a>
            </p>
        </div>

        <form method="post" id="reset-form" class="mt-8 space-y-6">
            {% csrf_token %}

            <!-- Step 1: Identifier Input -->
            <div id="step-1" class="space-y-6">
                <div>
                    <label for="id_auth_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Reset
                        via</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        {{ form.auth_type }}
                    </div>
                </div>

                <div id="email-field" style="display:none">
                    <label for="id_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email
                        address</label>
                    <div class="mt-1">
                        {{ form.email }}
                    </div>
                </div>

                <div id="phone-field" style="display:none">
                    <label for="id_phone_number"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Phone Number</label>
                    <div class="mt-1">
                        {{ form.phone_number }}
                    </div>
                </div>

                <div>
                    <button type="button" onclick="sendResetOtp()"
                        class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200">
                        Send OTP
                    </button>
                </div>
            </div>

            <!-- Step 2: OTP Verification -->
            <div id="step-2" style="display:none" class="space-y-6">
                <button type="button"
                    class="text-sm text-blue-600 hover:text-blue-500 dark:text-blue-400 mb-4 flex items-center"
                    onclick="goBack(1)">
                    <i class="fas fa-arrow-left mr-2"></i> Back
                </button>

                <div class="text-center mb-4">
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        We sent a verification code to your email/phone.
                    </div>
                </div>

                <div>
                    <label for="id_otp_verification"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Enter OTP</label>
                    <div class="mt-1">
                        {{ form.otp_verification }}
                    </div>
                </div>

                <div>
                    <button type="button" onclick="verifyResetOtp()"
                        class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 shadow-md transition-all duration-200">
                        Verify OTP
                    </button>
                </div>

                <div class="text-center mt-4">
                    <button type="button" id="resend-btn" onclick="sendResetOtp()"
                        class="text-sm font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400"
                        style="display:none">Resend OTP</button>
                    <div id="timer" class="text-sm text-gray-500">Resend OTP in <span id="time"
                            class="font-bold">30</span>s</div>
                </div>
            </div>

            <!-- Step 3: New Password -->
            <div id="step-3" style="display:none" class="space-y-6">
                <div>
                    <label for="id_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">New
                        Password</label>
                    <div class="mt-1">
                        {{ form.password }}
                        <!-- Reusing form.password field from UserRegisterForm for simplicity -->
                    </div>
                </div>

                <div>
                    <label for="id_confirm_password"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Confirm
                        New Password</label>
                    <div class="mt-1">
                        {{ form.confirm_password }}
                    </div>
                </div>

                <div>
                    <button type="button" onclick="submitNewPassword()"
                        class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200">
                        Reset Password
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
    /* Reuse same styles from sign_up.html for consistency */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    select {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
        background-color: #fff;
        color: #1f2937;
        margin-top: 0.25rem;
        transition: all 0.2s;
        outline: none;
    }

    input:focus,
    select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .dark input,
    .dark select {
        background-color: #374151;
        border-color: #4b5563;
        color: #f3f4f6;
    }
</style>

<script>
    const authType = document.getElementById("id_auth_type");
    const emailField = document.getElementById("email-field");
    const phoneField = document.getElementById("phone-field");
    const resendBtn = document.getElementById("resend-btn");
    const timerDiv = document.getElementById("timer");
    const timerSpan = document.getElementById("time");

    // Toggle fields based on auth type
    if (authType) {
        authType.addEventListener("change", () => {
            emailField.style.display = authType.value === "email" ? "block" : "none";
            phoneField.style.display = authType.value === "phone" ? "block" : "none";
        });
        authType.dispatchEvent(new Event("change"));
    }

    function sendResetOtp() {
        let auth_val = authType.value;
        let identifier = "";

        if (auth_val === 'email') {
            identifier = document.getElementById('id_email').value;
            if (!identifier) { alert("Please enter email"); return; }
        } else {
            identifier = document.getElementById('id_phone_number').value;
            if (!identifier) { alert("Please enter phone number"); return; }
        }

        // Call our new view
        fetch(`/sign-up/send-reset-otp/?auth_type=${auth_val}&identifier=${identifier}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    document.getElementById('step-1').style.display = 'none';
                    document.getElementById('step-2').style.display = 'block';
                    startTimer();
                } else {
                    alert(data.message); // e.g., "User not found"
                }
            })
            .catch(err => {
                console.error(err);
                alert("Failed to connect to server.");
            });
    }

    function verifyResetOtp() {
        let otp = document.getElementById('id_otp_verification').value;
        if (!otp) { alert("Enter OTP"); return; }

        fetch(`/sign-up/verify-reset-otp/?otp=${otp}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    alert("OTP Verified!");
                    document.getElementById("step-2").style.display = "none";
                    document.getElementById("step-3").style.display = "block";
                } else {
                    alert(data.message);
                }
            })
            .catch(err => console.error(err));
    }

    function submitNewPassword() {
        let p1 = document.getElementById('id_password').value;
        let p2 = document.getElementById('id_confirm_password').value;

        if (!p1 || !p2) { alert("Enter both passwords"); return; }
        if (p1 !== p2) { alert("Passwords do not match"); return; }

        fetch('/sign-up/reset-password-complete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Add CSRF token just in case, though view is csrf_exempt for simplicity here
            },
            body: JSON.stringify({ password: p1 })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert("Password reset successfully! Redirecting to login...");
                    window.location.href = "{% url 'login' %}";
                } else {
                    alert(data.message);
                }
            })
            .catch(err => console.error(err));
    }

    let otpTimer;
    let timeLeft = 30;
    function startTimer() {
        timeLeft = 30;
        resendBtn.style.display = "none";
        timerDiv.style.display = "block";
        timerSpan.innerText = timeLeft;

        clearInterval(otpTimer);
        otpTimer = setInterval(() => {
            timeLeft--;
            timerSpan.innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(otpTimer);
                timerDiv.style.display = "none";
                resendBtn.style.display = "block";
            }
        }, 1000);
    }

    function goBack(step) {
        if (step === 1) {
            document.getElementById("step-2").style.display = "none";
            document.getElementById("step-1").style.display = "block";
        }
    }
</script>
{% endblock %}