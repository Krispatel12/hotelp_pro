{% extends 'core/base.html' %}
{% load static %}

{% block title %}Sign Up - HotelPro{% endblock %}

{% block content %}
<div
    class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800">
    <div class="max-w-md w-full space-y-8 glass-card p-10 rounded-3xl relative overflow-hidden fade-in-up">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-purple-500"></div>

        <div class="text-center">
            <h2 class="mt-6 text-3xl font-extrabold text-gray-900 dark:text-white">
                Create your account
            </h2>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Or <a href="#" class="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400">sign in to your
                    existing account</a>
            </p>
        </div>

        <form method="post" id="registration-form" class="mt-8 space-y-6">
            {% csrf_token %}

            <!-- Step 1 -->
            <div id="step-1" class="space-y-6">
                <div>
                    <label for="id_auth_type"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Register with</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        {{ form.auth_type }}
                        <!-- Assuming form.auth_type renders a select or radio. If not styled by widget tweaks, might need extra JS or CSS targeting. 
                             For this example, rely on default widget rendering but wrapped in container. -->
                    </div>
                    <!-- Tailwind styling for select/inputs needs widget tweaking in forms.py or manual rendering. 
                          Here we apply basic classes to direct inputs via JS or simple CSS override in extra_css if needed.
                          Ideally, widgets should have class attrs.
                     -->
                </div>

                <div>
                    <label for="id_username"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                    <div class="mt-1">
                        {{ form.username }}
                    </div>
                </div>

                <div id="email-field" style="display:none">
                    <label for="id_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email
                        address</label>
                    <div class="mt-1">
                        {{ form.email }}
                    </div>
                </div>

                <div id="phone-field" style="display:none">
                    <label for="id_phone_number"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Phone Number</label>
                    <div class="mt-1">
                        {{ form.phone_number }}
                    </div>
                </div>

                <div>
                    <button type="button" onclick="sendOtp()"
                        class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200">
                        Send OTP
                    </button>
                </div>
            </div>

            <!-- Step 2 -->
            <div id="step-2" style="display:none" class="space-y-6">
                <button type="button"
                    class="text-sm text-blue-600 hover:text-blue-500 dark:text-blue-400 mb-4 flex items-center"
                    onclick="goBack(1)">
                    <i class="fas fa-arrow-left mr-2"></i> Back
                </button>

                <div class="text-center mb-4">
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        We sent a verification code to your email/phone.
                    </div>
                </div>

                <div>
                    <label for="id_otp_verification"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Enter OTP</label>
                    <div class="mt-1">
                        {{ form.otp_verification }}
                    </div>
                </div>

                <div>
                    <button type="button" onclick="verifyOtp()"
                        class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 shadow-md transition-all duration-200">
                        Verify OTP
                    </button>
                </div>

                <div class="text-center mt-4">
                    <button type="button" id="resend-btn" onclick="resendOTP()"
                        class="text-sm font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400"
                        style="display:none">Resend OTP</button>
                    <div id="timer" class="text-sm text-gray-500">Resend OTP in <span id="time"
                            class="font-bold">30</span>s</div>
                </div>
            </div>

            <!-- Step 3 -->
            <div id="step-3" style="display:none" class="space-y-6">
                <button type="button"
                    class="text-sm text-blue-600 hover:text-blue-500 dark:text-blue-400 mb-4 flex items-center"
                    onclick="goBack(2)">
                    <i class="fas fa-arrow-left mr-2"></i> Back
                </button>

                <div>
                    <label for="id_password"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                    <div class="mt-1">
                        {{ form.password }}
                    </div>
                </div>

                <div>
                    <label for="id_confirm_password"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Confirm Password</label>
                    <div class="mt-1">
                        {{ form.confirm_password }}
                    </div>
                </div>

                <div>
                    <button type="submit"
                        class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200">
                        Create Account
                    </button>
                </div>
            </div>

        </form>
    </div>
</div>

<!-- Styling for Django Form Widgets to match Tailwind -->
<style>
    /* Targeting input fields generated by Django */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    select {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
        background-color: #fff;
        color: #1f2937;
        margin-top: 0.25rem;
        transition: all 0.2s;
        outline: none;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus,
    select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    /* Dark mode overrides */
    .dark input[type="text"],
    .dark input[type="email"],
    .dark input[type="password"],
    .dark select {
        background-color: #374151;
        border-color: #4b5563;
        color: #f3f4f6;
    }

    .dark input[type="text"]:focus,
    .dark input[type="email"]:focus,
    .dark input[type="password"]:focus {
        border-color: #60a5fa;
    }
</style>

<script>
    const authType = document.getElementById("id_auth_type");
    const emailField = document.getElementById("email-field");
    const phoneField = document.getElementById("phone-field");
    const resendBtn = document.getElementById("resend-btn");
    const timerDiv = document.getElementById("timer");
    const timerSpan = document.getElementById("time");

    // Show correct field for auth type
    if (authType) {
        authType.addEventListener("change", () => {
            emailField.style.display = authType.value === "email" ? "block" : "none";
            phoneField.style.display = authType.value === "phone" ? "block" : "none";
        });
        // Trigger on load
        authType.dispatchEvent(new Event("change"));
    }

    function sendOtp() {
        let auth_val = authType.value;
        let email = document.getElementById('id_email').value;
        let phone = document.getElementById('id_phone_number').value;

        if (auth_val === 'email' && !email) {
            alert("Please enter email");
            return;
        }
        if (auth_val === 'phone' && !phone) {
            alert("Please enter phone number");
            return;
        }

        let url;
        if (auth_val === 'email') {
            url = `/sign-up/send-email-otp/?email=${email}`;
        } else {
            url = `/sign-up/send-whatsapp-otp/?phone_number=${phone}`;
        }

        fetch(url)
            .then(res => res.json())
            .then(data => {
                alert(data.message || "OTP Sent");
                if (data.status === 'success') {
                    document.getElementById('step-1').style.display = 'none';
                    document.getElementById('step-2').style.display = 'block';
                    startTimer();
                }
            })
            .catch(err => console.error(err));
    }

    let otpTimer;
    let timeLeft = 30;
    function startTimer() {
        timeLeft = 30;
        resendBtn.style.display = "none";
        timerDiv.style.display = "block";
        timerSpan.innerText = timeLeft;

        clearInterval(otpTimer);
        otpTimer = setInterval(() => {
            timeLeft--;
            timerSpan.innerText = timeLeft;

            if (timeLeft <= 0) {
                clearInterval(otpTimer);
                timerDiv.style.display = "none";
                resendBtn.style.display = "block";
            }
        }, 1000);
    }


    function resendOTP() {
        let auth_val = authType.value;
        let email = document.getElementById('id_email').value;
        let phone = document.getElementById('id_phone_number').value;

        let url;
        if (auth_val === 'email') {
            url = `/sign-up/send-email-otp/?email=${email}`;
        } else {
            url = `/sign-up/send-whatsapp-otp/?phone_number=${phone}`;
        }

        fetch(url)
            .then(res => res.json())
            .then(data => {
                alert(data.message || "OTP Resent");
                startTimer();
            })
            .catch(err => console.error(err));
    }


    function verifyOtp() {
        let enteredOtp = document.getElementById('id_otp_verification').value;
        let auth_val = authType.value;
        let email = document.getElementById('id_email').value;
        let phone = document.getElementById('id_phone_number').value;

        let url;
        if (auth_val === 'email') {
            url = `/sign-up/verify-email-otp/?email=${email}&otp=${enteredOtp}`;
        } else {
            url = `/sign-up/verify-whatsapp-otp/?phone=${phone}&otp=${enteredOtp}`;
        }

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    alert("OTP verified!");
                    document.getElementById("step-2").style.display = "none";
                    document.getElementById("step-3").style.display = "block";
                } else {
                    alert(data.message || "Invalid OTP");
                }
            })
            .catch(err => console.error(err));
    }


    function goBack(step) {
        if (step === 1) {
            document.getElementById("step-2").style.display = "none";
            document.getElementById("step-1").style.display = "block";
        }
        if (step === 2) {
            document.getElementById("step-3").style.display = "none";
            document.getElementById("step-2").style.display = "block";
        }
    }
</script>
{% endblock %}